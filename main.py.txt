import os
import telebot
import google.generativeai as genai
from flask import Flask, request
import logging

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
TOKEN = os.environ.get("TELEGRAM_TOKEN")
GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY")
try:
    ADMIN_ID = int(os.environ.get("ADMIN_ID"))
except:
    ADMIN_ID = 0

# --- Ø±Ø¨Ø§Øª Ùˆ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ---
bot = telebot.TeleBot(TOKEN)
genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel('gemini-pro')

# Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø±Ø¨Ø§Øª Ø±ÙˆÛŒ Ø±Ù†Ø¯Ø± Ø®Ø§Ù…ÙˆØ´ Ù†Ø´Ù‡ØŒ Ø§Ø² Ø±ÙˆØ´ Webhook Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒÚ©Ù†ÛŒÙ…
# (Ú†ÙˆÙ† Ø±Ù†Ø¯Ø± Ø±ÙˆØ´ Polling Ø±Ùˆ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø¯ØªÛŒ Ù‚Ø·Ø¹ Ù…ÛŒÚ©Ù†Ù‡)
server = Flask(__name__)

SYSTEM_INSTRUCTION = """
Ø´Ù…Ø§ Ø±Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ "RED SUITE" Ù‡Ø³ØªÛŒØ¯.
Ù„Ø­Ù†: Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡.
"""

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_id = message.from_user.id
    text = message.text

    # 1. Ø§Ø¯Ù…ÛŒÙ†
    if user_id == ADMIN_ID:
        if message.reply_to_message:
            try:
                targ = int(message.reply_to_message.text.split('\n')[0].replace("ğŸ†”:", "").strip())
                bot.send_message(targ, f"ğŸ‘¤ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: {text}")
                bot.reply_to(message, "âœ…")
            except: pass
        return

    # 2. Ù…Ø´ØªØ±ÛŒ
    try:
        bot.send_chat_action(user_id, 'typing')
        resp = model.generate_content(f"{SYSTEM_INSTRUCTION}\n\n{text}")
        bot.reply_to(message, resp.text)
    except:
        bot.reply_to(message, "Ø«Ø¨Øª Ø´Ø¯.")
    
    # 3. Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
    if ADMIN_ID:
        bot.send_message(ADMIN_ID, f"ğŸ†”: {user_id}\nğŸ‘¤ {message.from_user.first_name}\nğŸ“©: {text}")

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø±ÙˆØ± ---
@server.route('/' + TOKEN, methods=['POST'])
def getMessage():
    json_string = request.get_data().decode('utf-8')
    update = telebot.types.Update.de_json(json_string)
    bot.process_new_updates([update])
    return "!", 200

@server.route("/")
def webhook():
    bot.remove_webhook()
    # Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª Ø±Ù†Ø¯Ø± Ø±Ùˆ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ÛŒÚ¯ÛŒØ±Ù‡ ÙˆÙ„ÛŒ Ø§ÙˆÙ„Ø´ Ú©Ù‡ Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø¯Ø³ØªÛŒ Ø³Øª Ù…ÛŒÚ©Ù†ÛŒÙ…
    # Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ùˆ Ø¨Ø¹Ø¯Ø§ ØµØ¯Ø§ Ù…ÛŒØ²Ù†ÛŒÙ…
    return "Bot Running", 200

if __name__ == "__main__":
    # Ø±ÙˆÛŒ Ø±Ù†Ø¯Ø± Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ø§Ø¬Ø±Ø§ Ù†Ù…ÛŒØ´Ù‡ØŒ Ø¨Ù„Ú©Ù‡ Gunicorn Ø§Ø¬Ø±Ø§Ø´ Ù…ÛŒÚ©Ù†Ù‡
    server.run(host="0.0.0.0", port=int(os.environ.get('PORT', 5000)))
